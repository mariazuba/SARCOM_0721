---
title: "Análisis de sensibilidad"
lang: es
toc: TRUE
output: 
    pdf_document:
header-includes:
- \usepackage{draftwatermark}
- \SetWatermarkText{}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{parskip}
- \usepackage{caption}
- \captionsetup[table]{name=\textbf{Tabla},labelsep=period}
- \captionsetup[figure]{name=\textbf{Figura},labelsep=period}
- \captionsetup{justification=justified,format=plain,font=small,labelfont=bf,margin=50pt}
- \pagestyle{fancy}
- \usepackage{geometry}
- \geometry{top=1.5cm, bottom=1cm, left=2.5cm, right=2.5cm}
- \usepackage{helvet}
- \renewcommand{\familydefault}{\sfdefault}
- \renewcommand{\baselinestretch}{1.25}
- \newcommand{\sietepuntos}{\fontsize{7pt}{\baselineskip}\selectfont}
- \newcommand{\cincopuntos}{\fontsize{6pt}{\baselineskip}\selectfont}

- \addtolength{\headheight}{4.5\baselineskip}
- \setlength{\headheight}{70pt}
- \setlength{\footskip}{5pt}
- \setlength{\textheight}{658pt}
- \fancyhead[CO,CE]{\includegraphics[height=1.5cm]{logoifop.png}\\ \sietepuntos INSTITUTO DE FOMENTO PESQUERO / DIVISION INVESTIGACION PESQUERA}
- \fancyhead[LO,LE]{ }
- \fancyhead[RO,RE]{ }
- \renewcommand{\headrulewidth}{0.5pt}
- \fancyfoot[C]{\cincopuntos \thepage \\ \vspace{-0.2cm} ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ \\ \vspace{-0.2cm} \cincopuntos CONVENIO DE DESEMPEÑO 2020 IFOP/SUBSECRETARÍA DE ECONOMíA Y EMT \\ \vspace{-0.1cm} SEGUNDO INFORME. SARDINA COMÚN DE LA  REGIÓN DE VALPARAÍSO A LA REGIÓN DE LOS LAGOS, 2021. \textbf{ANEXO I}.}
---

\pagebreak

## Sensibilidad al MPDH

```{r llama codigos, warning=F, include=T, message=F, echo=FALSE}
library(knitr) # para generar reporte Rmarkdown
library(stringr)
library(reshape) 
library(dplyr) 
library(ggplot2)
library(ggthemes) # para ggplot
library(patchwork) # para unir gráficos de ggplot
library(strucchange) # libreria utilizada para análisis de quiebres

dir.Fig     <-"Figuras/" # carpeta de las figuras utilizadas y generadas en este estudio
fig         <-c("pdf") # formato de figuras generadas por este código
dir.0       <-getwd() # directorio de trabajo 
dir.1       <-paste(dir.0,"/codigos_admb",sep="") # carpeta de códigos ADMB 
dir.fun     <-paste(dir.0,"/funciones/",sep="") # carpeta de funciones utilizadas en este informe
source(paste(dir.fun,"functions.R",sep="")) # funciones para leer .dat y .rep
source(paste(dir.fun,"Fn_PBRs.R",sep="")) # funciones para leer .dat y .rep
ant <-reptoRlist(paste(dir.0,"/DatosEntrada.dat",sep=""))  # datos utilizados para antecedentes

```

```{r CORRE MODELO BASE SEPTIEMBRE, eval=FALSE, echo=FALSE, warning=FALSE, include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0920")
system("./MAE0920")
```

```{r CORRE MODELO BASE MARZO, eval=FALSE, echo=FALSE, warning=FALSE,include=F}
setwd(dir.1)
#Asesoría de septiembre
system("~/admb-12.2/admb MAE0321")
system("./MAE0321")
```

```{r  leer datos, echo=FALSE, warning=FALSE, include=T}
setwd(dir.1)

# ASESORÍA DE SEPTIEMBRE
data1        <- lisread("MAE0920.dat") 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist("MAE0920.rep")
std1         <- read.table("MAE0920.std",header=T,sep="",na="NA",fill=T) 

# ASESORÍA DE MARZO
data2        <- lisread("MAE0321.dat") 
names(data2) <- str_trim(names(data2), side="right")
dat2         <- data2
rep2         <- reptoRlist("MAE0321.rep")
std2         <- read.table("MAE0321.std",header=T,sep="",na="NA",fill=T) 
```

```{r Actualizacion, warning=F, include=F, message=F, echo=T,eval=F}
  
  Carpeta<-"/Sensibilidad_mph"
  dir<-paste(dir.0,Carpeta,sep="")
  system<-"mac"
  admb<-"MAE0321"
  dat_admb<-paste(admb,".dat",sep="")
  tpl_admb<-paste(admb,".tpl",sep="")

  
  setwd(dir.1)
  unlink(dir,recursive=T) #borra la carpeta creada
  dir.create(file.path(dir.0,Carpeta))#crea la carpeta nuevamente
  setwd(dir.1);file.copy(c(dat_admb,tpl_admb),dir) #copia los archivos de la carpeta creada
  
  setwd(dir) 
  data        <- lisread(paste(admb,".dat",sep="")) 
  names(data) <- str_trim(names(data), side="right")
  dat         <- data

 
  #==========================================================================
  #######################     CREA Y CORRE ESCENARIOS #####################
  #==========================================================================
  setwd(dir)
  #--------------
  # escenario 1: Caso 1 Igual al caso base
  #--------------
  dat<- data
  writeData(paste(admb,"s",1,".dat",sep=""), dat, append=FALSE)
  ###########################################################################
  # **Actualización 2020**
  ###########################################################################
  #--------------
  # escenario 2: CV de mpdh = 0.3
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  writeData(paste(admb,"s",2,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 3: CV de crucero pelaces = 0.25
  #--------------
  dat<- data
  dat$Ind[,5] <- rep(0.25,31)
  writeData(paste(admb,"s",3,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 4: CV de crucero reclas = 0.15
  #--------------
  dat<- data
  dat$Ind[,3] <- rep(0.15,31)
  writeData(paste(admb,"s",4,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 5: CV de crucero mpdh = 0.3, CV pelaces = 0.25
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  writeData(paste(admb,"s",5,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 6: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  dat$Ind[,3] <- rep(0.15,31)
  writeData(paste(admb,"s",6,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 7: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.3,31)
  dat$Ind[,3] <- rep(0.3,31)
  dat$Ind[,6] <- c(rep(0,11),498000,6000,5000,130000,0,198000,161000,356000,580000,0,158000,88000,84000,211000,66000,0,108000,103000,446000,0)
  writeData(paste(admb,"s",7,".dat",sep=""), dat, append=FALSE)
  
  #--------------
  # escenario 8: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  dat$Ind[,3] <- rep(0.15,31)
  dat$Ind[,6] <- c(rep(0,11),498000,6000,5000,130000,0,198000,161000,356000,580000,0,158000,88000,84000,211000,66000,0,108000,103000,446000,0)
  writeData(paste(admb,"s",8,".dat",sep=""), dat, append=FALSE)
  
   #--------------
  # escenario 9: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº1 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  dat$Ind[,3] <- rep(0.15,31)
  dat$Ind[,6] <- c(rep(0,11),246.4,17.6,13.1,84.8,0,1304.8,192.8,157.4,59.5,402.8,43.2,356.7,335.8,342.3,403.6,0,0,0,0,0)
  writeData(paste(admb,"s",9,".dat",sep=""), dat, append=FALSE)
  
   #--------------
  # escenario 10: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº2 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  dat$Ind[,3] <- rep(0.15,31)
  dat$Ind[,6] <- c(rep(0,11),1168,78,65,283,0,4175,652,601,182,1200,132,988,1028,0,0,0,0,0,0,0)
  writeData(paste(admb,"s",10,".dat",sep=""), dat, append=FALSE)
  
    #--------------
  # escenario 11: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº3 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  dat$Ind[,3] <- rep(0.15,31)
  dat$Ind[,6] <- c(rep(0,11),1.62,0,0.03,0.23,0,12.7,0.33,0.79,0.41,2.23,0.16,1.94,1.86,0,0,0,0,0,0,0)
  writeData(paste(admb,"s",11,".dat",sep=""), dat, append=FALSE)
  
     #--------------
  # escenario 12: CV de crucero mpdh = 0.3, CV pelaces = 0.25, CV reclas = 0.15, cambia índice de mpdh Nº4 
  #--------------
  dat<- data
  dat$Ind[,7] <- rep(0.3,31)
  dat$Ind[,5] <- rep(0.25,31)
  dat$Ind[,3] <- rep(0.15,31)
  dat$Ind[,6] <- c(rep(0,11),7.67,0,0.13,0.76,0,40.65,1.12,3.01,1.25,6.66,0.48,5.37,5.68,0,0,0,0,0,0,0)
  writeData(paste(admb,"s",12,".dat",sep=""), dat, append=FALSE)
  
  
  
  for(i in 1:12){
  setwd(dir.1);  file.copy(c(paste(admb,".tpl",sep="")),dir)
  setwd(dir);  file.rename(paste(admb,".tpl",sep=""),paste(admb,"s",i,".tpl",sep=""))
  
  if(system=="mac"){
    system(paste("~/admb-12.2/admb ",admb,"s",i,sep=""))
    system(paste("./",admb,"s",i,sep="")) }
  
  if(system=="windows"){
    system(paste("admb ",admb,"s",i,sep=""))
    system(paste(admb,"s",i,sep="")) }
  
  file.remove(paste(admb,"s",i,".htp", sep=""),
              paste(admb,"s",i,".cpp", sep=""),
              paste(admb,"s",i,".obj", sep=""),
              paste(admb,"s",i,".p01", sep=""),
              paste(admb,"s",i,".b01", sep=""),
              paste(admb,"s",i,".r01", sep=""),
              paste(admb,"s",i,".p02", sep=""),
              paste(admb,"s",i,".b02", sep=""),
              paste(admb,"s",i,".r02", sep=""),
              paste(admb,"s",i,".p03", sep=""),
              paste(admb,"s",i,".b03", sep=""),
              paste(admb,"s",i,".r03", sep=""),
              paste(admb,"s",i,".p04", sep=""),
              paste(admb,"s",i,".b04", sep=""),
              paste(admb,"s",i,".r04", sep=""),
              paste(admb,"s",i,".p05", sep=""),
              paste(admb,"s",i,".b05", sep=""),
              paste(admb,"s",i,".r05", sep=""),
              paste(admb,"s",i,".p06", sep=""),
              paste(admb,"s",i,".b06", sep=""),
              paste(admb,"s",i,".r06", sep=""),
              paste(admb,"s",i,".p07", sep=""),
              paste(admb,"s",i,".b07", sep=""),
              paste(admb,"s",i,".r07", sep=""),
              paste(admb,"s",i,".p08", sep=""),
              paste(admb,"s",i,".b08", sep=""),
              paste(admb,"s",i,".r08", sep=""),
              paste(admb,"s",i,".p09", sep=""),
              paste(admb,"s",i,".b09", sep=""),
              paste(admb,"s",i,".r09", sep=""),
              paste(admb,"s",i,".p10", sep=""),
              paste(admb,"s",i,".b10", sep=""),
              paste(admb,"s",i,".r10", sep=""),
              paste(admb,"s",i,".p11", sep=""),
              paste(admb,"s",i,".b11", sep=""),
              paste(admb,"s",i,".r11", sep=""),
              paste(admb,"s",i,".p12", sep=""),
              paste(admb,"s",i,".b12", sep=""),
              paste(admb,"s",i,".r12", sep=""),
              paste(admb,"s",i,".par", sep=""),
              paste(admb,"s",i,".bar", sep=""),
              paste(admb,"s",i,".eva", sep=""),
              paste(admb,"s",i,".cor", sep=""),
              paste(admb,"s",i,".log", sep=""),
              paste(admb,"s",i,".tpl", sep=""),
              paste(admb,"s",i,".exe", sep=""))
  
  }
  
```

\small

+------------+----------------------------------------------------------------------------------------+
| Escenarios | Descripción                                                                            |
+============+========================================================================================+
| S1         | igual a caso base                                                                      |
+------------+----------------------------------------------------------------------------------------+
| S2         | cambia CV mpdh a 0.3                                                                   |
+------------+----------------------------------------------------------------------------------------+
| S3         | cambia CV crucero otoño a 0.25                                                         |
+------------+----------------------------------------------------------------------------------------+
| S4         | cambia CV crucero verano a 0.15                                                        |
+------------+----------------------------------------------------------------------------------------+
| S5         | cambia CV mpdh 0.3 y CV crucero otoño a 0.25                                           |
+------------+----------------------------------------------------------------------------------------+
| S6         | cambia CV mpdh 0.3, CV crucero otoño a 0.25 y CV crucero verano 0.15                   |
+------------+----------------------------------------------------------------------------------------+
| S7         | índice MPDH actualizado, CV mpdh 0.3, CV crucero otoño a 0.30 y CV crucero verano 0.30 |
+------------+----------------------------------------------------------------------------------------+
| S8         | índice MPDH actualizado, CV mpdh 0.3, CV crucero otoño a 0.25 y CV crucero verano 0.15 |
+------------+----------------------------------------------------------------------------------------+
| S9         |                                                                                        |
+------------+----------------------------------------------------------------------------------------+
| S10        |                                                                                        |
+------------+----------------------------------------------------------------------------------------+

: Escenarios de sensibilidad respecto a coeficientes de variación (CV) de cruceros acústicos y mpdh

```{r dataindices,warning=F, include=T, message=F, echo=F }

yrs   <- rep2$years
nyrs  <- length(yrs)
lasty <- yrs[nyrs]
cvBcV   <-0.30
cvBcO   <-0.30
cvBcH   <-0.30
cvdes   <-0.01

Carpeta<-"/Sensibilidad_mph/"
  dir<-paste(dir.0,Carpeta,sep="")
admb<-"MAE0321"
#######################################################################################

years       <- rep2$years
nyears      <- length(years)
retros      <- seq(1,12)
nretros     <- length(retros)

                      
retroRecl    <- matrix(0,nrow=nyears,ncol=nretros)
retroPel     <- matrix(0,nrow=nyears,ncol=nretros)
retroMph     <- matrix(0,nrow=nyears,ncol=nretros)
retroDes     <- matrix(0,nrow=nyears,ncol=nretros)


for(i in 1:(nretros)){
  rep <- reptoRlist(paste(dir,admb,"s",i,".rep",sep=""))
  retroRecl[,i]  <- c(rep$reclaspred)
  retroPel[,i]   <- c(rep$pelacespred)
  retroMph[,i]   <- c(rep$mphpred)
  retroDes[,i]   <- c(rep$desembarquepred)
}



ind_obs             <- cbind(c(rep2$reclasobs),
                             c(rep2$pelacesobs),
                            c(rep(0,11),498000,6000,5000,130000,0,198000,
                              161000,356000,580000,0,158000,88000,84000,
                              211000,66000,0,108000,103000,446000,0),
                             c(rep2$desembarqueobs))
ind_obs[ind_obs==0] <- NA
colnames(ind_obs)   <- c('Crucero_verano', 
                         'Crucero_otoño',
                         'Crucero_huevos', 
                         'Desembarques') 

ind               <- data.frame(ind_obs) %>% 
                     mutate(Series='observado') %>% 
                     mutate (years=years) %>% 
                     melt(id.var=c('years', 'Series'))       

datR <- data.frame(years=years,
                   S1=retroRecl[,1],
                   S2=retroRecl[,2],
                   S3=retroRecl[,3],
                   S4=retroRecl[,4],
                   S5=retroRecl[,5],
                   S6=retroRecl[,6],
                   S7=retroRecl[,7],
                   S8=retroRecl[,8],
                   S9=retroRecl[,9],
                   S10=retroRecl[,10],
                   S11=retroRecl[,11],
                   S12=retroRecl[,12])%>% 
         mutate(Series=rep("Crucero_verano",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBT <- data.frame(years=years,
                   S1=retroPel[,1],
                   S2=retroPel[,2],
                   S3=retroPel[,3],
                   S4=retroPel[,4],
                   S5=retroPel[,5],
                   S6=retroPel[,6],
                   S7=retroPel[,7],
                   S8=retroPel[,8],
                   S9=retroPel[,9],
                   S10=retroPel[,10],
                   S11=retroPel[,11],
                   S12=retroPel[,12])%>% 
         mutate(Series=rep("Crucero_Otoño",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBD <- data.frame(years=years,
                   S1=retroMph[,1],
                   S2=retroMph[,2],
                   S3=retroMph[,3],
                   S4=retroMph[,4],
                   S5=retroMph[,5],
                   S6=retroMph[,6],
                   S7=retroMph[,7],
                   S8=retroMph[,8],
                   S9=retroMph[,9],
                   S10=retroMph[,10],
                   S11=retroMph[,11],
                   S12=retroMph[,12])%>% 
         mutate(Series=rep("Crucero_huevos",nyears))%>%
         melt(id.var=c('years', 'Series'))

datF <- data.frame(years=years,
                   S1=retroDes[,1],
                   S2=retroDes[,2],
                   S3=retroDes[,3],
                   S4=retroDes[,4],
                   S5=retroDes[,5],
                   S6=retroDes[,6],
                   S7=retroDes[,7],
                   S8=retroDes[,8],
                   S9=retroDes[,9],
                   S10=retroDes[,10],
                   S11=retroDes[,11],
                   S12=retroDes[,12])%>% 
         mutate(Series=rep("Desembarques",nyears))%>%
         melt(id.var=c('years', 'Series'))

data2 <- data.frame(rbind(ind,datR,datBT,datBD,datF)) 

```

```{r Fig26CCTPPjulio,warning=F, include=T, message=F, echo=F,fig.height=8,fig.width=6.5,fig.align="center",fig.path=dir.Fig,dev=fig}
f1<- ggplot(data2 %>% filter(Series=="Crucero_verano"),
            aes(years,value)) +   
     geom_line(aes(colour=variable), size=0.3)+
    geom_point(data = data2 %>% filter(Series=='observado', variable=='Crucero_verano'),
       aes(years,value), shape = 19, colour = 'gray30') +
     geom_errorbar(data = data2 %>% filter(Series=='observado', variable=='Crucero_verano'),
       aes(ymin = value*exp(-1.96*cvBcV), ymax = value*exp(1.96*cvBcV)), color = 'gray30') +
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Crucero_verano')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data2 %>% filter(Series=="Crucero_Otoño"),
            aes(years,value)) +   
     geom_line(aes(colour=variable), size=0.3)+
    geom_point(data = data2 %>% filter(Series=='observado', variable=='Crucero_otoño'),
       aes(years,value), shape = 19, colour = 'gray30') +
     geom_errorbar(data = data2 %>% filter(Series=='observado', variable=='Crucero_otoño'),
       aes(ymin = value*exp(-1.96*cvBcO), ymax = value*exp(1.96*cvBcO)), color = 'gray30') +
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Crucero_Otoño')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data2 %>% filter(Series=="Crucero_huevos"),
            aes(years,value)) +   
     geom_line(aes(colour=variable), size=0.3)+
    geom_point(data = data2 %>% filter(Series=='observado', variable=='Crucero_huevos'),
       aes(years,value), shape = 19, colour = 'gray30') +
     geom_errorbar(data = data2 %>% filter(Series=='observado', variable=='Crucero_huevos'),
       aes(ymin = value*exp(-1.96*cvBcH), ymax = value*exp(1.96*cvBcH)), color = 'gray30') +
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Crucero_huevos')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")


(f1/f2/f3)


```

+------------+------------------------------------------------------------------------------+
| índice     | Descripción                                                                  |
+============+==============================================================================+
| índice Nº1 | índice de densidad de huevos estandarizado obtenido con MLG familia Tweedie  |
+------------+------------------------------------------------------------------------------+
| índice Nº2 | índice obtenido mediante la multiplicación de la densidad de huevos (h/m2) y |
|            |                                                                              |
|            | la duración del período de desove                                            |
+------------+------------------------------------------------------------------------------+
| índice Nº3 | índice obtenido mediante la multiplicación de la densidad de huevos (h/m2) y |
|            |                                                                              |
|            | el área de desove                                                            |
+------------+------------------------------------------------------------------------------+
| índice Nº4 | índice obtenido mediante la multiplicación de la densidad de huevos (h/m2),  |
|            |                                                                              |
|            | el área de desove y la duración del período de desove                        |
+------------+------------------------------------------------------------------------------+

```{r índices_alternativosCCTPPjulio,echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=4, fig.width=10,fig.path=dir.Fig,dev=fig}

ind1<-c(rep(NA,11),246.4,17.6,13.1,84.8,NA,1304.8,192.8,157.4,59.5,402.8,43.2,356.7,335.8,342.3,403.6,NA,NA,NA,NA,NA)
ind2<-c(rep(NA,11),1168,78,65,283,NA,4175,652,601,182,1200,132,988,1028,NA,NA,NA,NA,NA,NA,NA)
ind3<-c(rep(NA,11),1.62,NA,0.03,0.23,NA,12.7,0.33,0.79,0.41,2.23,0.16,1.94,1.86,NA,NA,NA,NA,NA,NA,NA)
ind4<-c(rep(NA,11),7.67,NA,0.13,0.76,NA,40.65,1.12,3.01,1.25,6.66,0.48,5.37,5.68,NA,NA,NA,NA,NA,NA,NA)

ind1A<-c(rep(NA,5),139.6,508,285.6,597.5,1994.3,429.4,149,492.4,188.9,43,81.3,247.2,469.2,244.7,NA,NA,NA,NA,NA,NA)
ind2A<-c(rep(NA,5),694,2568,1285,2283,6214,1410,496,1934,841,199,363,983,NA,NA,NA,NA,NA,NA,NA,NA)
ind3A<-c(rep(NA,5),1.31,NA,1.73,4.02,25.49,2.39,1.14,3.72,1.35,0.12,0.34,1.69,NA,NA,NA,NA,NA,NA,NA,NA)
ind4A<-c(rep(NA,5),6.5,NA,7.77,15.35,79.43,7.84,3.79,14.63,6,0.54,1.52,6.72,NA,NA,NA,NA,NA,NA,NA,NA)

tabla<-cbind(rep2$years,ind1,ind2,ind3,ind4)
kable(tabla)
par(mfcol=c(1,2),mar=c(4,4,1,4))
plot(rep2$years,ind1,type="o",pch=19,col=1,ylim=c(0,4500),ylab="Densidad - índice 1 y 2",xlab="",main="Sardina común")
lines(rep2$years,ind2,type="o",pch=19,col=2)
par(new=TRUE)
plot(rep2$years,ind3,type="o",pch=19,col=3,axes=F,ylim=c(0,50),ylab="",xlab="")
axis(4,cex.axis=0.7,las=1)
mtext("Densidad - índice 3 y 4",side=4,line=3)
lines(rep2$years,ind4,type="o",pch=19,col=4)
legend(1990,50,c("índice Nº1","índice Nª2","índice Nª3","índice Nº4"),col=c(1,2,3,4),pch=19,lwd=1,bty="n")


plot(seq(1997,2021),ind1A,type="o",pch=19,col=1,ylim=c(0,6500),ylab="Densidad - índice 1 y 2",xlab="",main="Anchoveta centro-sur")
lines(seq(1997,2021),ind2A,type="o",pch=19,col=2)
par(new=TRUE)
plot(seq(1997,2021),ind3A,type="o",pch=19,col=3,axes=F,ylim=c(0,90),ylab="",xlab="")
axis(4,cex.axis=0.7,las=1)
mtext("Densidad - índice 3 y 4",side=4,line=3)
lines(seq(1997,2021),ind4A,type="o",pch=19,col=4)
legend(2011,60,c("índice Nº1","índice Nª2","índice Nª3","índice Nº4"),col=c(1,2,3,4),pch=19,lwd=1,bty="n")





```


```{r areadesove_duracioncruceroCCTPPjulio,echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=4, fig.width=10,fig.path=dir.Fig,dev=fig}

areadesoveS<-c(6568,NA,2042,2686,NA,9737,1716,5004,6874,5545,3627,5432,5525)
areadesoveA<-c(9373,NA,6051,6727,NA,12782,5557,7635,7563,7135,2708,4189,6837)
duraciondesoveS<-c(4.74,4.43,4.99,3.34,NA,3.2,3.38,3.82,3.06,2.98,3.05,2.77,3.06)
duraciondesoveA<-c(4.97,5.05,4.5,3.82,NA,3.12,3.28,3.33,3.93,4.45,4.62,4.46,3.98)

par(mfcol=c(1,2),mar=c(4,4,1,4))
plot(seq(2002,2014),areadesoveS,type="o",col=1,ylim=c(0,13000),ylab="Área de desove (km2)",pch=19,xlab="Años")
lines(seq(2002,2014),areadesoveA,type="o",col=2,pch=19)

plot(seq(2002,2014),duraciondesoveS,type="o",col=1,ylab="Duración del desove (meses)",pch=19,xlab="Años")
lines(seq(2002,2014),duraciondesoveA,type="o",col=2,pch=19)

legend(2006,5,c("Anchoveta","Sardina común"),col=c(2,1),lwd=1,pch=19,bty="n")
```


```{r VariablesMarzo_std, echo=F,message=FALSE, warning=FALSE, include=T}

years<-rep2$years
nyears<-length(years)
x  <-c(years,rev(years))


Rt2      <- subset(std2,name=="Reclutas")$value 
Rt2std   <- subset(std2,name=="Reclutas")$std
BT2      <- subset(std2,name=="BT")$value   
BT2std   <- subset(std2,name=="BT")$std
BD2      <- subset(std2,name=="SSB")$value   
BD2std   <- subset(std2,name=="SSB")$std
Ft2      <- subset(std2,name=="log_Ft")$value   
Ft2std   <- subset(std2,name=="log_Ft")$std

VarPob<- data.frame(x=years, 
                    Rt2=Rt2,
                    BT2=BT2,
                    BD2=BD2,
                    Ft2=exp(Ft2), 
         lowerRt2 = (Rt2 -1.96*Rt2std), 
         upperRt2 = (Rt2+1.96*Rt2std),
         lowerBT2 = (BT2 -1.96*BT2std),
         upperBT2 = (BT2+1.96*BT2std),
         lowerBD2 = (BD2 -1.96*BD2std), 
         upperBD2 = (BD2+1.96*BD2std),
         lowerFt2 = exp(Ft2 -1.96*Ft2std), 
         upperFt2 = exp(Ft2+1.96*Ft2std))

```

```{r variables, echo=F,message=FALSE, warning=FALSE, include=T}

Carpeta<-"/Sensibilidad_mph/"
  dir<-paste(dir.0,Carpeta,sep="")


admb<-"MAE0321"
#######################################################################################

years       <- rep2$years
nyears      <- length(years)
retros      <- seq(1,12)
nretros     <- length(retros)

                      
retroR      <- matrix(0,nrow=nyears,ncol=nretros)
retroBD     <- matrix(0,nrow=nyears,ncol=nretros)
retroBT     <- matrix(0,nrow=nyears,ncol=nretros)
retroF      <- matrix(0,nrow=nyears,ncol=nretros)


for(i in 1:(nretros)){
  rep <- reptoRlist(paste(dir,admb,"s",i,".rep",sep=""))
  retroR[,i]  <- c(rep$Reclutas)
  retroBD[,i] <- c(rep$SSB)
  retroBT[,i] <- c(rep$BT)
  retroF[,i]  <- c(rep$Ftot) 
}


# Diferencia relativa con caso base actual 
    rel.diff.r   <- matrix(NA, nrow=nyears, ncol=(nretros))
    rel.diff.ssb <- matrix(NA, nrow=nyears, ncol=(nretros))
    rel.diff.bt  <- matrix(NA, nrow=nyears, ncol=(nretros))
    rel.diff.f   <- matrix(NA, nrow=nyears, ncol=(nretros))
    
    for(j in 1:nretros){
      rel.diff.r[,j]          <- (retroR[,(j)]-retroR[,1])/retroR[,1]
      rel.diff.ssb[,j]        <- (retroBD[,(j)]-retroBD[,1])/retroBD[,1]
      rel.diff.bt[,j]         <- (retroBT[,(j)]-retroBT[,1])/retroBT[,1]
      rel.diff.f[,j]          <- (retroF[,(j)]-retroF[,1])/retroF[,1]
    }
    
    
```

```{r data1, echo=F,message=FALSE, warning=FALSE, include=T}

datR <- data.frame(years=years,
                   S1=retroR[,1],
                   S2=retroR[,2],
                   S3=retroR[,3],
                   S4=retroR[,4],
                   S5=retroR[,5],
                   S6=retroR[,6],
                   S7=retroR[,7],
                   S8=retroR[,8],
                   S9=retroR[,9],
                   S10=retroR[,10],
                   S11=retroR[,11],
                   S12=retroR[,12])%>% 
         mutate(Series=rep("Reclutamientos",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBT <- data.frame(years=years,
                   S1=retroBT[,1],
                   S2=retroBT[,2],
                   S3=retroBT[,3],
                   S4=retroBT[,4],
                   S5=retroBT[,5],
                   S6=retroBT[,6],
                   S7=retroBT[,7],
                   S8=retroBT[,8],
                   S9=retroBT[,9],
                   S10=retroBT[,10],
                   S11=retroBT[,11],
                   S12=retroBT[,12])%>% 
         mutate(Series=rep("Biomasa_total",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBD <- data.frame(years=years,
                   S1=retroBD[,1],
                   S2=retroBD[,2],
                   S3=retroBD[,3],
                   S4=retroBD[,4],
                   S5=retroBD[,5],
                   S6=retroBD[,6],
                   S7=retroBD[,7],
                   S8=retroBD[,8],
                   S9=retroBD[,9],
                   S10=retroBD[,10],
                   S11=retroBD[,11],
                   S12=retroBD[,12])%>% 
         mutate(Series=rep("Biomasa_desovante",nyears))%>%
         melt(id.var=c('years', 'Series'))

datF <- data.frame(years=years,
                   S1=retroF[,1],
                   S2=retroF[,2],
                   S3=retroF[,3],
                   S4=retroF[,4],
                   S5=retroF[,5],
                   S6=retroF[,6],
                   S7=retroF[,7],
                   S8=retroF[,8],
                   S9=retroF[,9],
                   S10=retroF[,10],
                   S11=retroF[,11],
                   S12=retroF[,12])%>% 
         mutate(Series=rep("Mortalidad_por_pesca",nyears))%>%
         melt(id.var=c('years', 'Series'))

data1 <- data.frame(rbind(datR,datBT,datBD,datF)) 



```

```{r Fig1CCTPPjulio,echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig}
#######################################################################################
# GRAFICAS
#######################################################################################

f1<- ggplot(data1 %>% filter(Series=="Reclutamientos")) + 
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerRt2, ymax=upperRt2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Reclutamientos')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data1 %>% filter(Series=="Biomasa_total")) +  
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerBT2, ymax=upperBT2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = 'toneladas',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa total')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data=data1 %>% filter(Series=="Biomasa_desovante")) +  
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerBD2, ymax=upperBD2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = 'toneladas',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa desovante')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")

f4<- ggplot(data1 %>% filter(Series=="Mortalidad_por_pesca")) +
     geom_line(aes(years,value,colour=variable), size=0.3)+
     geom_ribbon(data=VarPob,aes(ymin=lowerFt2, ymax=upperFt2, x=x, fill = "IC"), alpha = 0.2)+
     labs(x = '', y = '',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Mortalidad por pesca')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

(f1/f2) | (f3/f4)

```

```{r diferencias, echo=F,message=FALSE, warning=FALSE, include=T}

datR <- data.frame(years=years,
                   S1=rel.diff.r[,1],
                   S2=rel.diff.r[,2],
                   S3=rel.diff.r[,3],
                   S4=rel.diff.r[,4],
                   S5=rel.diff.r[,5],
                   S6=rel.diff.r[,6],
                   S7=rel.diff.r[,7],
                   S8=rel.diff.r[,8],
                   S9=rel.diff.r[,9],
                   S10=rel.diff.r[,10],
                   S11=rel.diff.r[,11],
                   S12=rel.diff.r[,12])%>% 
         mutate(Series=rep("Reclutamientos",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBT <- data.frame(years=years,
                   S1=rel.diff.bt[,1],
                   S2=rel.diff.bt[,2],
                   S3=rel.diff.bt[,3],
                   S4=rel.diff.bt[,4],
                   S5=rel.diff.bt[,5],
                   S6=rel.diff.bt[,6],
                   S7=rel.diff.bt[,7],
                   S8=rel.diff.bt[,8],
                   S9=rel.diff.bt[,9],
                   S10=rel.diff.bt[,10],
                   S11=rel.diff.bt[,11],
                   S12=rel.diff.bt[,12])%>% 
         mutate(Series=rep("Biomasa_total",nyears))%>%
         melt(id.var=c('years', 'Series'))

datBD <- data.frame(years=years,
                   S1=rel.diff.ssb[,1],
                   S2=rel.diff.ssb[,2],
                   S3=rel.diff.ssb[,3],
                   S4=rel.diff.ssb[,4],
                   S5=rel.diff.ssb[,5],
                   S6=rel.diff.ssb[,6],
                   S7=rel.diff.ssb[,7],
                   S8=rel.diff.ssb[,8],
                   S9=rel.diff.ssb[,9],
                   S10=rel.diff.ssb[,10],
                   S11=rel.diff.ssb[,11],
                   S12=rel.diff.ssb[,12])%>% 
         mutate(Series=rep("Biomasa_desovante",nyears))%>%
         melt(id.var=c('years', 'Series'))

datF <- data.frame(years=years,
                   S1=rel.diff.f[,1],
                   S2=rel.diff.f[,2],
                   S3=rel.diff.f[,3],
                   S4=rel.diff.f[,4],
                   S5=rel.diff.f[,5],
                   S6=rel.diff.f[,6],
                   S7=rel.diff.f[,7],
                   S8=rel.diff.f[,8],
                   S9=rel.diff.f[,9],
                   S10=rel.diff.f[,10],
                   S11=rel.diff.f[,11],
                   S12=rel.diff.f[,12])%>% 
         mutate(Series=rep("Mortalidad_por_pesca",nyears))%>%
         melt(id.var=c('years', 'Series'))

data <- data.frame(rbind(datR,datBT,datBD,datF)) 

```

```{r Fig2,echo=F, message=FALSE, warning=FALSE, include=T, fig.align="center", fig.height=6, fig.width=8,fig.path=dir.Fig,dev=fig,eval=F}
#######################################################################################
# GRAFICAS
#######################################################################################
f1<- ggplot(data %>% filter(Series=="Reclutamientos"),
            aes(years,value)) +   ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Reclutamientos')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f2<- ggplot(data %>% filter(Series=="Biomasa_total"),
            aes(years,value)) +   ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa total')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

f3<- ggplot(data %>% filter(Series=="Biomasa_desovante"),
            aes(years,value)) +   ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Biomasa desovante')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="left")

f4<- ggplot(data %>% filter(Series=="Mortalidad_por_pesca"),
            aes(years,value)) +
      ylim(-0.30, 0.30) + 
     geom_line(aes(colour=variable), size=0.3)+
     labs(x = '', y = 'Diferencia relativa',colour='Asesorías')  +
     scale_x_continuous(breaks = seq(from = 1990, to = 2021, by = 5)) +
     scale_colour_manual(values=seq(1,12,1))+
     theme_bw(base_size=9) + 
     ggtitle('Mortalidad por pesca')+
     theme(plot.title = element_text(hjust = 0.5),legend.position="none")

(f1/f2) | (f3/f4)
```

\pagebreak
